# Cleanup Plan

> **Goal:** Remove all technical debt, template pollution, and workarounds.  
> **Estimated Effort:** 4-6 hours  
> **Rule:** Complete each phase before starting the next. Run `npm run build` after every change.
> **Last Updated:** 2026-01-25 (All phases completed)

**Prerequisites:** Read `AGENTS.md` for project context and architecture overview.

---

## Phase 1: Critical Fixes (1 hour) ✅ COMPLETED

Must complete before any other work. These are blocking issues.

**Why critical:** These issues cause runtime failures, security risks, or block development tooling.

### 1.1 Fix Hardcoded User Path ✅
- **File:** `src/lib/session-loader.ts:7`
- **Problem:** Absolute path breaks for any user except original developer
- **Fixed:** Changed to `path.join(os.homedir(), '.local/share/opencode/storage')`

### 1.2 Fix ESLint ✅ (with caveats)
- **File:** `package.json`
- **Problem:** `next lint` command no longer exists in Next.js 16
- **Fixed:** Changed to `"lint": "eslint src"`
- **⚠️ Known Issue:** ESLint still fails due to pre-existing `.eslintrc.json` circular reference error (see Known Issues section below)

### 1.3 Remove Debug from Production API ✅
- **File:** `src/app/api/sessions/route.ts`
- **Fixed:** Debug info now only included when `NODE_ENV === 'development'`

### 1.4 Fix isOverATask Bug ✅
- **File:** `src/features/kanban/components/kanban-board.tsx`
- **Problem:** Copy-paste error checked `activeData` twice instead of `overData`
- **Fixed:** Changed to `const isOverATask = overData?.type === 'Task'`

### 1.5 Fix Duplicate setTasks Call ✅
- **File:** `src/features/kanban/components/kanban-board.tsx`
- **Problem:** State updated twice in same handler
- **Fixed:** Added proper `else` branch to avoid unconditional second call

---

## Phase 2: Template Cleanup (1.5 hours) ✅ COMPLETED

Delete all unused template code. Less code = less bugs.

**Why:** Project was forked from `next-shadcn-dashboard-starter`. These files are template artifacts with no relevance to session management.

### 2.1 Delete Dead Files ✅
- ~~`src/constants/data.ts`~~ - Deleted
- ~~`src/constants/mock-api.ts`~~ - Deleted
- ~~`../MyInspect/`~~ - Deleted

### 2.2 Remove Unused Dependencies ✅
```bash
npm uninstall @faker-js/faker @clerk/themes  # Done
```

### 2.3 Clean next.config.ts ✅
- Removed Clerk image domains (img.clerk.com, clerk.com)

### 2.4 Update Package Identity ✅
- Changed `"name": "next-shadcn-dashboard-starter"` → `"name": "openkanban"`

### 2.5 Update Metadata ✅
- Updated title to `OpenKanban` and description to `Session manager for OpenCode`

### 2.6 Delete Data-Table Feature Chain ✅
All 14 files deleted:
- `src/components/ui/table/data-table*.tsx` (9 files)
- `src/lib/data-table.ts`, `src/lib/parsers.ts`, `src/lib/format.ts`
- `src/hooks/use-data-table.ts`
- `src/types/data-table.ts`
- `src/config/data-table.ts`

### 2.7 Delete Other Unused Files ✅
- ~~`src/lib/searchparams.ts`~~ - Deleted
- ~~`src/types/base-form.ts`~~ - Deleted

### 2.8 Delete Unused Forms Directory ✅ (Additional cleanup)
- ~~`src/components/forms/`~~ - Entire directory deleted (10 files including demo-form.tsx)
- These were template form components with no usage in the app

**Verification:** `npm run build` passes ✅

---

## Phase 3: Code Quality (1.5 hours) ✅ COMPLETED

Fix Clean Code violations.

### 3.1 Fix Type Issues ✅
- **File:** `kanban-board.tsx:37`
- **Fixed:** Changed `useState<Boolean>` → `useState<boolean>`

### 3.2 Remove Commented Code ✅
- `task-card.tsx:10-14` - Deleted commented Task interface
- `board-column.tsx:91-95` - Deleted commented JSX

### 3.3 Fix Naming ✅
- `store.ts:10` - Renamed `status` → `columnId` (and all 15 usages across store, mapping, kanban-board)
- `dashboard/kanban/page.tsx:7` - Renamed `function page()` → `function Page()`

### 3.4 Fix Form IDs ✅
- `new-section-dialog.tsx` - Changed `id='todo-form'` → `id='new-section-form'`
- `new-task-dialog.tsx` - Changed `id='todo-form'` → `id='new-task-form'`

### 3.5 Fix Typo ✅
- **File:** `src/lib/utils.ts:23`
- **Fixed:** `'Bytest'` → `'Bytes'`

### 3.6 Extract Magic Number ✅
- **File:** `src/lib/session-loader.ts`
- **Fixed:** Added `const MAX_SESSIONS = 100` and changed `.slice(0, 100)` → `.slice(0, MAX_SESSIONS)`

### 3.7 Remove Unused Mapping Strategies ✅
- **File:** `src/features/kanban/utils/mapping.ts`
- **Fixed:** Removed `MappingStrategy` type and unused strategy parameter. Function now: `mapDataToKanban(data: SessionAPIResponse): KanbanData`

**Verification:** `npm run build` passes ✅

---

## Phase 4: Architecture Fixes (1 hour) ✅ COMPLETED

Fix structural issues that cause subtle bugs.

### 4.1 Convert to Async File I/O ✅
- **File:** `src/lib/session-loader.ts`
- **Fixed:** Converted all 11 sync file operations to async (`fs.promises.*`)
- **Fixed:** Updated function signatures to return `Promise<...>`
- **Fixed:** Updated `src/app/api/sessions/route.ts` to `await` both functions

### 4.2 Add Error Logging ✅
- **File:** `src/lib/session-loader.ts`
- **Fixed:** Added `console.warn` to all 3 catch blocks with file context

### 4.3 Fix State Mutation ✅
- **File:** `src/features/kanban/components/kanban-board.tsx`
- **Fixed:** Both locations now use immutable updates via `tasks.map()` before `setTasks`

### 4.4 Fix DOM Workaround ✅
- **File:** `src/features/kanban/components/column-action.tsx`
- **Fixed:** Replaced `<Button>` with `<AlertDialogAction>` using `buttonVariants`
- **Fixed:** Removed `setTimeout` workaround and manual `setShowDeleteDialog(false)`

### 4.5 Implement Loading State ✅
- **File:** `src/features/kanban/components/kanban-board.tsx`
- **Fixed:** Added `isLoading` and `setIsLoading` from store
- **Fixed:** Added `setIsLoading(true)` before fetch and `.finally(() => setIsLoading(false))`
- **Fixed:** Added loading skeleton with 3 animated placeholder columns

**Verification:** `npm run build` passes ✅, `npm run dev` works ✅, API returns data ✅

---

## Phase 5: Remove Sentry (15 min) ✅ COMPLETED

Remove unconfigured Sentry integration. This is a personal session manager, not a production SaaS requiring error monitoring.

**Why remove:** The `FIXME: Add your Sentry organization` comment in `next.config.ts:25` confirms it was never configured. Removing ~150 lines of dormant integration code is cleaner than keeping unused complexity.

### 5.1 Uninstall Dependency ✅
```bash
npm uninstall @sentry/nextjs  # Removed 117 packages
```

### 5.2 Delete Instrumentation Files ✅
```bash
rm src/instrumentation.ts
rm src/instrumentation-client.ts
```

### 5.3 Delete Global Error Handler ✅ (Additional discovery)
```bash
rm src/app/global-error.tsx  # Also imported @sentry/nextjs
```

### 5.4 Simplify next.config.ts ✅
Replaced 58-line Sentry-wrapped config with 16-line clean config.

### 5.5 Clean Build Cache ✅
```bash
rm -rf .next  # Required to clear cached Sentry references
```

**Verification:** `npm run build` passes ✅, `npm run dev` works ✅, API returns data ✅, no server errors ✅

---

## Known Issues

### ESLint Configuration Circular Reference
- **Status:** Pre-existing, not introduced by cleanup
- **Symptom:** Running `npm run lint` fails with:
  ```
  TypeError: Converting circular structure to JSON
  Referenced from: /path/to/OpenKanban/.eslintrc.json
  ```
- **Root Cause:** The `.eslintrc.json` extends `eslint-config-next` which has a circular reference issue with ESLint 8.x
- **Impact:** Cannot run lint checks via CLI
- **Workarounds:**
  1. IDE-based linting still works (VS Code ESLint extension)
  2. TypeScript compilation catches type errors (`npm run build`)
- **Potential Fix:** Migrate to ESLint flat config (`eslint.config.js`) or update ESLint/eslint-config-next versions

---

## Verification Checklist

After completing all phases:

- [x] `npm run build` passes
- [ ] `npm run lint` passes (blocked by Known Issue above)
- [x] `npm run dev` loads kanban board
- [x] Sessions load from `~/.local/share/opencode/storage`
- [x] No console errors in server logs
- [x] No TypeScript errors
- [x] `grep -r "david.helmus" src/` returns nothing
- [x] `grep -r "todo-form" src/` returns nothing
- [x] `grep -r "Boolean" src/` returns nothing (for useState)

---

## Files Modified Summary

| Phase | Files Changed | Files Deleted | Status |
|-------|---------------|---------------|--------|
| 1 | 4 | 0 | ✅ Done |
| 2 | 4 | 30 | ✅ Done |
| 3 | 9 | 0 | ✅ Done |
| 4 | 4 | 0 | ✅ Done |
| 5 | 1 | 3 | ✅ Done |
| 6 | 0 | 14 | ✅ Done |
| 7 | 4 | 0 | ✅ Done |

**Completed:** ~17 files modified, ~47 files deleted

### Phase 2 Deletion Breakdown (Actual)
- `src/constants/` - 2 files (data.ts, mock-api.ts)
- `src/components/ui/table/data-table-*.tsx` - 9 files
- `src/components/forms/` - 10 files (entire directory)
- `src/lib/` - 4 files (data-table.ts, parsers.ts, format.ts, searchparams.ts)
- `src/hooks/use-data-table.ts` - 1 file
- `src/types/` - 2 files (data-table.ts, base-form.ts)
- `src/config/data-table.ts` - 1 file
- `../MyInspect/` - 1 directory

---

## Template Recovery

This project was forked from [next-shadcn-dashboard-starter](https://github.com/Kiranism/next-shadcn-dashboard-starter) by Kiranism.

If you need any deleted template components in the future:
1. Clone the original: `git clone https://github.com/Kiranism/next-shadcn-dashboard-starter.git`
2. Copy the needed files into this project
3. Update imports as needed (paths may differ)

**Deleted template artifacts include:** data-tables, forms, mock APIs, Clerk auth components, RBAC types, nav components, file uploader, multi-step forms, and various unused hooks.

---

## Phase 6: Dead Code Cleanup ✅ COMPLETED

Additional unused template files discovered during Phase 3. Safe to delete.

### 6.1 Unused Hooks ✅
All deleted:
- ~~`src/hooks/use-multistep-form.tsx`~~
- ~~`src/hooks/use-debounced-callback.ts`~~
- ~~`src/hooks/use-media-query.ts`~~
- ~~`src/hooks/use-debounce.tsx`~~
- ~~`src/hooks/use-callback-ref.ts`~~

### 6.2 Unused Components ✅
All deleted:
- ~~`src/components/nav-main.tsx`~~
- ~~`src/components/nav-user.tsx`~~
- ~~`src/components/nav-projects.tsx`~~
- ~~`src/components/file-uploader.tsx`~~
- ~~`src/components/modal/alert-modal.tsx`~~
- ~~`src/components/form-card-skeleton.tsx`~~

### 6.3 Unused Config ✅
- ~~`src/config/infoconfig.ts`~~ (244 lines of Clerk/RBAC docs)

### 6.4 Dependency Chain ✅
Deleted orphaned hooks after `file-uploader.tsx` removal:
- ~~`src/hooks/use-controllable-state.tsx`~~
- ~~`src/hooks/use-callback-ref.tsx`~~

**Total deleted:** 14 files

**Verification:** `npm run build` passes ✅

---

## Phase 7: Additional Code Quality ✅ COMPLETED

Issues discovered during audit. Lower priority than Phase 4-6.

### 7.1 Accessibility ✅
Added `aria-label` to all inputs:
- `new-task-dialog.tsx` - Task title and description inputs
- `new-section-dialog.tsx` - Section title input
- `column-action.tsx` - Column name input

### 7.2 Magic Numbers ✅
Extracted constants:
- `column-action.tsx` - `FOCUS_DELAY_MS = 500`
- `infobar.tsx` - `PATHNAME_CHANGE_DELAY_MS = 200`

### 7.3 Type Safety ✅
- Resolved automatically - `use-multistep-form.tsx` was deleted in Phase 6

**Verification:** `npm run build` passes ✅

---

## Post-Cleanup

After completing this plan:

1. Update `docs/ISSUES.md` - mark resolved items as done
2. Run full test of all features
3. Commit with message: `chore: complete codebase cleanup per CLEANUP.md`
4. Delete this file or move to `docs/_archive/`
