# Spec: Phase 4.1 - Backend Core & Filtering

> **Goal**: Update the backend to support filtering boards by `parentId`.
> **Context**: Currently `listBoards` returns all boards. The frontend needs to show only boards for the active project.

## 1. Requirements

### 1.1 Repository Layer
- **File**: `OpenKanban/src/lib/db/repository.ts`
- **Interface Update**: Update `listBoards` signature to accept an optional filter.
    ```typescript
    listBoards(filter?: { parentId?: string }): BoardWithParsedFields[];
    ```
- **Implementation**:
    - In `SqlitePMRepository.listBoards`, if `filter.parentId` is provided:
    - Retrieve all boards.
    - Parse `board.filters` JSON.
    - Filter results in-memory where `parsedFilters.parentId === filter.parentId`.
    - **Note**: `board.filters` is a JSON string. Use `this.parseBoardFields` helper or manual parsing.

### 1.2 Service Layer
- **File**: `OpenKanban/src/services/board-service.ts`
- **Update**: Pass the filter argument from `BoardService.listBoards` to `repo.listBoards`.

### 1.3 API Layer
- **File**: `OpenKanban/src/app/api/boards/route.ts`
- **Update**: In the `GET` handler:
    - Parse `parentId` from the request URL search params.
    - Call `service.listBoards({ parentId })` if present.

### 1.4 Testing
- **File**: `OpenKanban/src/lib/db/__tests__/repository-boards.test.ts` (Create new file)
- **Tests**:
    - `should create a board with parentId filter`
    - `should list only boards matching parentId`
    - `should return all boards if no filter provided`
    - `should delete a board`

## 2. Definition of Done
- [ ] `npm run test` passes (specifically the new `repository-boards.test.ts`).
- [ ] `GET /api/boards?parentId=123` returns filtered results (can be verified via curl or postman locally).
- [ ] No regression in existing `npm run build`.

## 3. Implementation Plan
1.  Create `repository-boards.test.ts` first (TDD).
2.  Update `IPMRepository` interface.
3.  Update `SqlitePMRepository` implementation.
4.  Update `BoardService`.
5.  Update `GET /api/boards` route.
6.  Run tests to verify.
