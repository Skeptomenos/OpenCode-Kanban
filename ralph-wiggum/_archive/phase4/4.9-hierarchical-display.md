# Work Plan: 4.9 Hierarchical Display

## Context

### Original Request
Visualize parent/child relationships on task cards (e.g., showing "Epic: Authentication" above a task title).

### Interview Summary
**Key Discussions**:
- Tasks can have parents (Epic > Story > Task hierarchy)
- Currently cards show flat list without parent context
- Need lightweight parent metadata: id, title, type only
- Parent badge should appear at top of card, before title

**Research Findings**:
- `task-card.tsx`: Clean ~100 line component, badge at top is feasible
- `Task` type needs extension to include `parent` field
- Backend `fetchIssues` needs to support `includeParents` param
- Icons from `@tabler/icons-react` available for type indicators

### Spec Reference
- `ralph-wiggum/specs/4.9-hierarchical-display.md`

---

## Work Objectives

### Core Objective
Display parent information on TaskCards so users understand hierarchy context.

### Concrete Deliverables
- Updated `Task` type with optional `parent` field
- Updated `fetchIssues` API to include parent data
- Updated `TaskCard` component with parent badge

### Definition of Done
- [ ] TaskCards show parent badge when `parentId` exists
- [ ] Badge shows correct icon based on parent type
- [ ] Long parent titles truncate with ellipsis
- [ ] No performance regression (no N+1 queries)
- [ ] `pnpm run build` passes
- [ ] `pnpm run lint` passes

### Must Have
- Parent badge visible on cards with parents
- Type-specific icons (Project, Epic, Story, etc.)
- Truncation for long titles

### Must NOT Have (Guardrails)
- Full parent object fetch (only id, title, type)
- Click navigation to parent (future enhancement)
- Nested hierarchy display (only immediate parent)
- Performance regression from N+1 queries

---

## Verification Strategy

### Test Decision
- **Approach**: Manual verification with browser automation
- **QA approach**: Create a task with parent, verify display

---

## Task Flow

```
Task 1 (Types) → Task 2 (Backend) → Task 3 (API) → Task 4 (UI)
```

## Parallelization

| Task | Depends On | Reason |
|------|------------|--------|
| 1 | None | Type definitions first |
| 2 | 1 | Needs types |
| 3 | 2 | Needs backend support |
| 4 | 3 | Needs data available |

---

## TODOs

- [ ] 1. Extend Task Type with Parent Field

  **What to do**:
  - Update `OpenKanban/src/features/kanban/types.ts` 
  - Add `ParentInfo` type with id, title, type
  - Add optional `parent` field to `Task` type

  **Must NOT do**:
  - Don't make parent required (many tasks don't have parents)
  - Don't include full parent object (only lightweight metadata)

  **Parallelizable**: NO (must complete first)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/kanban/types.ts` - Current Task type definition

  **Code to Add**:
  ```typescript
  /**
   * Lightweight parent information for hierarchical display.
   * Used to show parent context on task cards without fetching full parent.
   */
  export interface ParentInfo {
    id: string;
    title: string;
    type: string; // 'project' | 'milestone' | 'epic' | 'story' | 'task'
  }

  export interface Task {
    id: string;
    title: string;
    columnId: string;
    description?: string;
    parent?: ParentInfo; // NEW: Optional parent for hierarchy display
  }
  ```

  **Acceptance Criteria**:
  - [ ] `ParentInfo` interface defined
  - [ ] `Task` interface has optional `parent` field
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(kanban): add ParentInfo type for hierarchical display`
  - Files: `src/features/kanban/types.ts`

---

- [ ] 2. Update Backend Repository to Include Parent Data

  **What to do**:
  - Update `OpenKanban/src/lib/db/repository.ts`
  - Modify `listIssues` query to LEFT JOIN parent title/type
  - Return parent metadata in query results

  **Must NOT do**:
  - Don't create N+1 query pattern
  - Don't fetch full parent objects
  - Don't break existing listIssues callers

  **Parallelizable**: NO (depends on 1)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/lib/db/repository.ts` - `listIssues` method
  - Drizzle ORM join patterns

  **Database Schema Reference**:
  - `issues` table has `parent_id` column referencing another issue

  **Implementation Approach**:
  
  Option A (SQL Join - preferred if Drizzle supports):
  ```typescript
  // In listIssues method, add JOIN to fetch parent
  const results = await db.select({
    ...issues,
    parentTitle: parentIssues.title,
    parentType: parentIssues.type,
  })
  .from(issues)
  .leftJoin(parentIssues, eq(issues.parentId, parentIssues.id))
  .where(/* existing filters */);
  ```

  Option B (Self-join alias):
  ```typescript
  // Create alias for self-join
  const parentAlias = alias(issues, 'parent');
  
  // Join in query
  .leftJoin(parentAlias, eq(issues.parentId, parentAlias.id))
  ```

  **Acceptance Criteria**:
  - [ ] `listIssues` returns parent id, title, type for issues with parents
  - [ ] No N+1 queries (single query with JOIN)
  - [ ] Issues without parents return `parent: null` or `parent: undefined`
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(db): add parent metadata to listIssues query`
  - Files: `src/lib/db/repository.ts`

---

- [ ] 3. Update Frontend API to Map Parent Data

  **What to do**:
  - Update `OpenKanban/src/features/kanban/api.ts`
  - Update issue type/mapping to include parent
  - Update `fetchIssues` to return `Issue` with parent

  **Must NOT do**:
  - Don't change API endpoint signature
  - Don't add new API endpoints

  **Parallelizable**: NO (depends on 2)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/kanban/api.ts` - `fetchIssues` function
  - `OpenKanban/src/contract/pm/schemas.ts` - Issue schema if exists

  **Updates Required**:

  1. **Update Issue type** (or create IssueWithParent):
  ```typescript
  export interface Issue {
    id: string;
    title: string;
    description: string | null;
    status: string;
    parentId: string | null;
    // NEW fields from backend
    parent?: {
      id: string;
      title: string;
      type: string;
    };
  }
  ```

  2. **Update fetchIssues response mapping** if needed:
  ```typescript
  // Map API response to include parent
  const issues = data.data.map(issue => ({
    ...issue,
    parent: issue.parentTitle ? {
      id: issue.parentId,
      title: issue.parentTitle,
      type: issue.parentType,
    } : undefined,
  }));
  ```

  **Acceptance Criteria**:
  - [ ] `fetchIssues` returns issues with `parent` field populated
  - [ ] Parent field is undefined for root-level issues
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(api): include parent metadata in fetchIssues response`
  - Files: `src/features/kanban/api.ts`

---

- [ ] 4. Update fetchKanbanData to Map Parent to Task

  **What to do**:
  - Update `OpenKanban/src/features/kanban/components/kanban-board.tsx`
  - Modify `fetchKanbanData` to include parent in Task objects
  - Map Issue.parent to Task.parent

  **Must NOT do**:
  - Don't change drag-and-drop logic
  - Don't change column handling

  **Parallelizable**: NO (depends on 3)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/kanban/components/kanban-board.tsx:L78-94` - Task mapping in fetchKanbanData

  **Current Code** (line 81-86):
  ```typescript
  tasks = issues.map((issue) => ({
    id: issue.id,
    title: issue.title,
    description: issue.description ?? undefined,
    columnId: issue.status,
  }));
  ```

  **Updated Code**:
  ```typescript
  tasks = issues.map((issue) => ({
    id: issue.id,
    title: issue.title,
    description: issue.description ?? undefined,
    columnId: issue.status,
    parent: issue.parent, // NEW: Include parent info
  }));
  ```

  **Acceptance Criteria**:
  - [ ] Tasks include parent field when available
  - [ ] No TypeScript errors
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(kanban): map parent data in fetchKanbanData`
  - Files: `src/features/kanban/components/kanban-board.tsx`

---

- [ ] 5. Update TaskCard to Display Parent Badge

  **What to do**:
  - Update `OpenKanban/src/features/kanban/components/task-card.tsx`
  - Add parent badge above title when `task.parent` exists
  - Use type-specific icons from @tabler/icons-react
  - Style with `text-xs text-muted-foreground`
  - Truncate long titles with ellipsis

  **Must NOT do**:
  - Don't add click navigation (future)
  - Don't show if no parent exists
  - Don't change existing card layout significantly

  **Parallelizable**: NO (depends on 4)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/kanban/components/task-card.tsx:L72-102` - Current card layout
  - `OpenKanban/src/features/kanban/components/task-card.tsx:L94-96` - Badge usage pattern

  **Icon Mapping**:
  ```typescript
  import { 
    IconFolder,      // project
    IconFlag,        // milestone
    IconTarget,      // epic
    IconBook,        // story
    IconSquareCheck  // task
  } from '@tabler/icons-react';

  const PARENT_TYPE_ICONS: Record<string, typeof IconFolder> = {
    project: IconFolder,
    milestone: IconFlag,
    epic: IconTarget,
    story: IconBook,
    task: IconSquareCheck,
  };
  ```

  **UI Addition** (after line 83, before CardHeader):
  ```typescript
  // Add inside Card, before CardHeader
  {task.parent && (
    <div className="flex items-center gap-1 px-3 pt-2 text-xs text-muted-foreground">
      {(() => {
        const Icon = PARENT_TYPE_ICONS[task.parent.type] ?? IconFolder;
        return <Icon className="h-3 w-3 flex-shrink-0" />;
      })()}
      <span className="truncate" title={task.parent.title}>
        {task.parent.title}
      </span>
    </div>
  )}
  ```

  **Full Updated Component Structure**:
  ```typescript
  return (
    <Card ...>
      {/* NEW: Parent badge */}
      {task.parent && (
        <div className="flex items-center gap-1 px-3 pt-2 text-xs text-muted-foreground">
          {(() => {
            const Icon = PARENT_TYPE_ICONS[task.parent.type] ?? IconFolder;
            return <Icon className="h-3 w-3 flex-shrink-0" />;
          })()}
          <span className="truncate max-w-[200px]" title={task.parent.title}>
            {task.parent.title}
          </span>
        </div>
      )}
      <CardHeader ...>
        {/* existing drag handle and badge */}
      </CardHeader>
      <CardContent ...>
        {task.title}
      </CardContent>
    </Card>
  );
  ```

  **Acceptance Criteria**:

  **Manual Verification** (using Playwright):
  - [ ] Navigate to: `http://localhost:37291/project/[projectId]/board/[boardId]`
  - [ ] Create a task with a parent (Epic or Story)
  - [ ] Verify: Parent badge appears above task title
  - [ ] Verify: Correct icon displayed based on parent type
  - [ ] Verify: Long parent titles truncate with ellipsis
  - [ ] Verify: Hover shows full title in tooltip
  - [ ] Screenshot: Save to `.sisyphus/evidence/4.9-parent-badge.png`

  **Build Verification**:
  - [ ] `pnpm run build` → 0 errors
  - [ ] `pnpm run lint` → 0 errors

  **Commit**: YES
  - Message: `feat(kanban): add parent badge to TaskCard for hierarchy display`
  - Files: `src/features/kanban/components/task-card.tsx`

---

## Commit Strategy

| After Task | Message | Files | Verification |
|------------|---------|-------|--------------|
| 1 | `feat(kanban): add ParentInfo type` | types.ts | pnpm build |
| 2 | `feat(db): add parent metadata to listIssues` | repository.ts | pnpm build |
| 3 | `feat(api): include parent in fetchIssues` | api.ts | pnpm build |
| 4 | `feat(kanban): map parent in fetchKanbanData` | kanban-board.tsx | pnpm build |
| 5 | `feat(kanban): add parent badge to TaskCard` | task-card.tsx | pnpm build + manual test |

---

## Success Criteria

### Verification Commands
```bash
pnpm run build  # Expected: 0 errors
pnpm run lint   # Expected: 0 errors
```

### Final Checklist
- [ ] Tasks with parents show parent badge
- [ ] Badge has correct type icon
- [ ] Long titles truncate properly
- [ ] Tasks without parents show no badge
- [ ] No N+1 query performance issues
- [ ] Build and lint pass
