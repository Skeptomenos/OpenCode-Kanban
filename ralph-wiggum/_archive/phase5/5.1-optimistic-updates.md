# Spec: Phase 5.1 - Optimistic Updates for Board Mutations

> **Goal**: Implement optimistic updates for board mutations to improve perceived performance.
> **Context**: Current mutations use cache invalidation, causing a refetch and brief loading state after every action.
> **Issue Reference**: `docs/phase4-board-management-issues.md#L3`

## 1. Problem Statement

All board mutations in `use-board-mutations.ts` use simple invalidation:
```typescript
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ['boards'] });
},
```

This causes:
- Network request after every mutation
- Brief loading state before UI updates
- Perceived lag, especially on slow connections

## 2. Requirements

### 2.1 Optimistic Update for useUpdateBoard (Rename)
- **File**: `OpenKanban/src/features/boards/hooks/use-board-mutations.ts`
- **Imports**: Ensure correct types are imported
    ```typescript
    import type { BoardListItem, UpdateBoardInput } from '@/features/kanban/api';
    // Note: BoardListItem is the list type used in cache, not BoardWithParsedFields
    ```

- **Implementation**:
    ```typescript
    export function useUpdateBoard() {
      const queryClient = useQueryClient();

      return useMutation({
        mutationFn: ({ id, input }: { id: string; input: UpdateBoardInput }) =>
          updateBoard(id, input),
        onMutate: async ({ id, input }) => {
          // Cancel any outgoing refetches (fuzzy matching handles { parentId })
          // Note: Using { queryKey: ['boards'] } matches all board queries 
          // including ['boards', { parentId: '...' }]
          await queryClient.cancelQueries({ queryKey: ['boards'] });
          
          // Snapshot the previous value
          const previousBoards = queryClient.getQueriesData<BoardListItem[]>({ queryKey: ['boards'] });

          // Optimistically update to the new value
          queryClient.setQueriesData<BoardListItem[]>(
            { queryKey: ['boards'] },
            (old) => old?.map((b) => (b.id === id ? { ...b, ...input } : b))
          );

          // Return context with the snapshotted value
          return { previousBoards };
        },
        onError: (_err, _variables, context) => {
          // Rollback on error
          if (context?.previousBoards) {
            context.previousBoards.forEach(([queryKey, data]) => {
              queryClient.setQueryData<BoardListItem[]>(queryKey, data);
            });
          }
        },
        onSettled: () => {
          // Always refetch after error or success
          queryClient.invalidateQueries({ queryKey: ['boards'] });
        },
      });
    }
    ```

### 2.2 Optimistic Update for useDeleteBoard
- **File**: `OpenKanban/src/features/boards/hooks/use-board-mutations.ts`
- **Implementation**:
    ```typescript
    export function useDeleteBoard() {
      const queryClient = useQueryClient();

      return useMutation({
        mutationFn: (id: string) => deleteBoard(id),
        onMutate: async (id) => {
          await queryClient.cancelQueries({ queryKey: ['boards'] });
          const previousBoards = queryClient.getQueriesData<BoardListItem[]>({ queryKey: ['boards'] });

          queryClient.setQueriesData<BoardListItem[]>(
            { queryKey: ['boards'] },
            (old) => old?.filter((b) => b.id !== id)
          );

          return { previousBoards };
        },
        onError: (_err, _id, context) => {
          if (context?.previousBoards) {
            context.previousBoards.forEach(([queryKey, data]) => {
              queryClient.setQueryData<BoardListItem[]>(queryKey, data);
            });
          }
        },
        onSettled: () => {
          queryClient.invalidateQueries({ queryKey: ['boards'] });
        },
      });
    }
    ```

### 2.3 Keep useCreateBoard As-Is
- Creating requires server-generated ID
- Optimistic create is complex and error-prone
- Current invalidation pattern is acceptable

## 3. Definition of Done
- [ ] `useUpdateBoard` uses optimistic update pattern with correct types (`BoardListItem`)
- [ ] `useDeleteBoard` uses optimistic update pattern with correct types
- [ ] UI updates immediately on rename
- [ ] UI updates immediately on delete
- [ ] Errors rollback to previous state
- [ ] Final state syncs with server via `onSettled`
- [ ] `npm run build` passes
- [ ] `npm run lint` passes

## 4. Implementation Plan
1. Read current `use-board-mutations.ts` to verify existing imports
2. Add explicit type imports if missing
3. Implement optimistic update for `useUpdateBoard`
4. Test rename
5. Implement optimistic update for `useDeleteBoard`
6. Test delete

## 5. Testing Strategy
**Manual Verification Steps:**
1. **Network Throttling**: 
   - Open DevTools > Network > Preset: "Fast 3G" or "Offline"
   - Perform rename/delete actions
   - Verify UI updates *instantly* before network request finishes

2. **Rollback Verification**:
   - Temporarily modify `mutationFn` to throw error:
     `mutationFn: async () => { await new Promise(r => setTimeout(r, 1000)); throw new Error('Test'); }`
   - Trigger mutation
   - Verify UI updates optimistically, then reverts after 1s

## 6. Estimated Effort
2-3 hours
