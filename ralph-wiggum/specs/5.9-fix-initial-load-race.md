# Spec: Phase 5.9 - Fix Initial Load Race Condition

> **Goal:** Ensure task cards render on initial page load without requiring a manual refresh.
> **Context:** Task cards sometimes don't appear on first load but appear after reload.
> **Priority:** P1 - High (confusing UX, appears broken)

## Background

The Kanban board occasionally shows empty columns on initial page load, despite tasks existing in the database. A manual page refresh fixes the issue. This is a classic hydration/timing bug.

**Observed Behavior:**
1. User navigates to `/project/[projectId]/board/[boardId]`
2. Columns render correctly (Backlog, In Progress, Done)
3. Task cards are missing
4. Browser console shows no JavaScript errors
5. Manual refresh (F5) â†’ cards appear

## Root Cause Analysis

The board uses a hybrid state management approach:
1. **React Query** fetches data from API and caches it
2. **Zustand** holds UI state for drag-and-drop responsiveness
3. **useEffect** syncs React Query data to Zustand

**File:** `src/features/kanban/components/kanban-board.tsx`

Suspected timing issue:
```typescript
// Simplified current logic
const { data, isLoading } = useQuery({
  queryKey: queryKeys.kanban(boardId),
  queryFn: () => fetchKanbanData(projectId, boardId, filters),
});

const { tasks, setTasks } = useTaskStore();

useEffect(() => {
  if (data && draggedTask === null) {
    setTasks(data.tasks);  // Sync to Zustand
  }
}, [data, draggedTask, setTasks]);

// UI renders from `tasks` (Zustand), not `data` (React Query)
return (
  <BoardContainer>
    {columns.map(col => (
      <BoardColumn key={col.id}>
        {tasks.filter(t => t.columnId === col.id).map(task => (
          <TaskCard key={task.id} task={task} />
        ))}
      </BoardColumn>
    ))}
  </BoardContainer>
);
```

**Problem Scenarios:**
1. **Zustand initialized empty**: `tasks = []` initially, UI renders before sync
2. **useEffect skipped on first render**: Effect runs after initial paint
3. **SSR/hydration mismatch**: Server renders with empty tasks, client has data

## 1. Add Loading State
**File:** `src/features/kanban/components/kanban-board.tsx`

**Current:** May not show loading state if query resolves before component mounts.

**Fix:** Add explicit loading handling:
```typescript
const { data, isLoading } = useQuery({
  queryKey: queryKeys.kanban(boardId),
  queryFn: () => fetchKanbanData(projectId, boardId, filters),
});

if (isLoading) {
  return <BoardSkeleton />;  // Show loading skeleton
}

if (!data) {
  return <EmptyBoardState />;  // Handle no-data case
}
```

## 2. Render from Query Data Directly
**File:** `src/features/kanban/components/kanban-board.tsx`

**Alternative approach:** Reduce dependency on Zustand for initial render:
```typescript
// Use React Query data as source of truth for rendering
// Only use Zustand for optimistic updates during drag

const tasksToRender = draggedTask !== null 
  ? tasks  // Use Zustand during drag (for immediate updates)
  : data?.tasks ?? [];  // Use React Query otherwise

return (
  <BoardContainer>
    {columns.map(col => (
      <BoardColumn key={col.id}>
        {tasksToRender.filter(t => t.columnId === col.id).map(task => (
          <TaskCard key={task.id} task={task} />
        ))}
      </BoardColumn>
    ))}
  </BoardContainer>
);
```

## 3. Ensure useEffect Dependencies Are Complete
**File:** `src/features/kanban/components/kanban-board.tsx`

**Check:** Verify all dependencies are in the array:
```typescript
useEffect(() => {
  if (data && draggedTask === null) {
    setTasks(data.tasks);
  }
}, [data, draggedTask, setTasks]);  // All dependencies present?
```

**Potential Issue:** If `setTasks` reference changes, effect may not fire correctly.

**Fix:** Use stable reference:
```typescript
const setTasksRef = useRef(setTasks);
setTasksRef.current = setTasks;

useEffect(() => {
  if (data && draggedTask === null) {
    setTasksRef.current(data.tasks);
  }
}, [data, draggedTask]);  // setTasksRef is stable
```

## 4. Force Sync on Mount
**File:** `src/features/kanban/components/kanban-board.tsx`

Add an immediate sync when data is available:
```typescript
// Force initial sync
useEffect(() => {
  if (data?.tasks) {
    setTasks(data.tasks);
  }
}, []);  // Empty deps = run once on mount

// Also sync when data changes (existing effect)
useEffect(() => {
  if (data && draggedTask === null) {
    setTasks(data.tasks);
  }
}, [data, draggedTask, setTasks]);
```

## 5. Check React Query Stale Settings
**File:** `src/lib/query-client.ts`

**Check:** Query client configuration:
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 0,  // Data considered stale immediately
      refetchOnMount: true,  // Refetch when component mounts
      refetchOnWindowFocus: false,  // Optional
    },
  },
});
```

**If `staleTime` is high:** Cached data may be used without refetch, causing stale renders.

## 6. Add Suspense Boundary (React 18+)
**File:** `src/app/project/[projectId]/board/[boardId]/page.tsx`

If using React Server Components:
```typescript
import { Suspense } from 'react';
import { BoardSkeleton } from '@/features/kanban/components/board-skeleton';

export default function BoardPage({ params }: Props) {
  return (
    <Suspense fallback={<BoardSkeleton />}>
      <KanbanBoard projectId={params.projectId} boardId={params.boardId} />
    </Suspense>
  );
}
```

## 7. Debug with Logging
**File:** `src/features/kanban/components/kanban-board.tsx`

Add temporary logging to trace the issue:
```typescript
useEffect(() => {
  console.log('[KanbanBoard] Mount', { 
    hasData: !!data,
    taskCount: data?.tasks?.length,
    zustandTaskCount: tasks.length,
    draggedTask 
  });
}, []);

useEffect(() => {
  console.log('[KanbanBoard] Data changed', {
    taskCount: data?.tasks?.length,
    zustandTaskCount: tasks.length,
    willSync: data && draggedTask === null
  });
  
  if (data && draggedTask === null) {
    setTasks(data.tasks);
  }
}, [data, draggedTask, setTasks]);
```

## Verification Checklist
- [ ] Navigate to board page
- [ ] Task cards appear immediately (no flash of empty state)
- [ ] Console shows sync happening
- [ ] Refresh page multiple times - cards always appear
- [ ] Navigate away and back - cards still appear
- [ ] Test on slow network (DevTools throttle) - loading skeleton shows

## Files to Modify
| File | Action |
|------|--------|
| `src/features/kanban/components/kanban-board.tsx` | Add loading state, fix sync logic |
| `src/app/project/[projectId]/board/[boardId]/page.tsx` | Add Suspense boundary |
| `src/lib/query-client.ts` | Verify staleTime settings |
| `src/features/kanban/components/board-skeleton.tsx` | Create if missing |

## Related Files
- `src/features/kanban/utils/store.ts` - Zustand store definition
- `src/features/kanban/api.ts` - Data fetching functions
