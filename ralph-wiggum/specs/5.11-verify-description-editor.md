# Spec: Phase 5.11 - Verify Description Editor Functionality

> **Goal:** Verify the auto-saving description editor loads and saves correctly.
> **Context:** The editor exists but wasn't fully tested due to InfoSidebar rendering bug.
> **Priority:** P2 - Medium (functionality verification)
> **Prerequisite:** Fix ISSUE-5.6 (InfoSidebar rendering) first

## Background

The `TaskDescriptionEditor` component is designed to:
1. Load the task's existing description
2. Allow editing in a textarea
3. Auto-save on blur or Cmd+Enter
4. Show "Saved" indicator on success

This spec covers verifying the editor works correctly once the InfoSidebar renders.

## 1. Component Structure
**File:** `src/features/kanban/components/task-description-editor.tsx`

**Expected Props:**
```typescript
interface TaskDescriptionEditorProps {
  taskId: string;
  initialDescription: string;
}
```

**Expected Behavior:**
- Textarea displays `initialDescription` on mount
- Local state tracks changes
- Mutation fires on blur or Cmd+Enter
- Success shows visual feedback

## 2. Verify Initial Value Loading
**File:** `src/features/kanban/components/task-card.tsx`

**Check:** Ensure `initialDescription` is passed correctly:
```tsx
const content: InfobarContent = {
  title: task.title,
  sections: [
    {
      title: 'Description',
      description: (
        <TaskDescriptionEditor
          taskId={task.id}
          initialDescription={task.description || ''}  // Must pass actual value
        />
      ),
      links: []
    }
  ],
  // ...
};
```

**Potential Issue:** If `task.description` is `undefined` (not fetched), editor shows placeholder.

**Verification Steps:**
1. Find a task with an existing description in the database
2. Click on that task
3. InfoSidebar should show the description text, not "Add a description..."

## 3. Verify Auto-Save on Blur
**File:** `src/features/kanban/components/task-description-editor.tsx`

**Expected Implementation:**
```tsx
const handleBlur = () => {
  if (value !== initialDescription) {
    updateMutation.mutate({ id: taskId, description: value });
  }
};

<Textarea
  value={value}
  onChange={(e) => setValue(e.target.value)}
  onBlur={handleBlur}
  placeholder="Add a description..."
/>
```

**Verification Steps:**
1. Click task to open InfoSidebar
2. Type in description textarea
3. Click outside the textarea (blur)
4. Check network tab for PATCH `/api/issues/[id]` request
5. Refresh page
6. Verify description persists

## 4. Verify Auto-Save on Keyboard Shortcut
**File:** `src/features/kanban/components/task-description-editor.tsx`

**Expected Implementation:**
```tsx
const handleKeyDown = (e: React.KeyboardEvent) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
    e.preventDefault();
    if (value !== initialDescription) {
      updateMutation.mutate({ id: taskId, description: value });
    }
  }
};

<Textarea
  onKeyDown={handleKeyDown}
  // ...
/>
```

**Verification Steps:**
1. Type in description textarea
2. Press Cmd+Enter (Mac) or Ctrl+Enter (Windows)
3. Should see "Saved" indicator
4. Refresh and verify

## 5. Verify "Saved" Indicator
**File:** `src/features/kanban/components/task-description-editor.tsx`

**Expected UI:**
```tsx
{updateMutation.isSuccess && (
  <div className="flex items-center gap-1 text-xs text-muted-foreground">
    <IconCheck className="h-3 w-3" />
    <span>Saved</span>
  </div>
)}
```

**Alternative:** Use toast notification:
```tsx
import { toast } from 'sonner';

const updateMutation = useMutation({
  onSuccess: () => {
    toast.success('Description saved');
  },
  onError: () => {
    toast.error('Failed to save description');
  },
});
```

## 6. Verify API Endpoint
**File:** `src/app/api/issues/[id]/route.ts`

**Check:** PATCH endpoint accepts `description`:
```typescript
export async function PATCH(request: Request, { params }: RouteParams) {
  const body = await request.json();
  
  // Validate
  const { description, ...rest } = UpdateIssueSchema.parse(body);
  
  // Update
  const updated = await issueService.update(params.id, { description, ...rest });
  
  return NextResponse.json({ success: true, data: updated });
}
```

**Check:** Zod schema includes `description`:
```typescript
const UpdateIssueSchema = z.object({
  title: z.string().optional(),
  description: z.string().optional(),  // Must be present
  status: z.string().optional(),
  // ...
});
```

## 7. Verify Mutation Hook
**File:** `src/features/kanban/hooks/use-issue-mutations.ts` (or similar)

**Expected:**
```typescript
export function useUpdateIssueMutation() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async ({ id, ...data }: { id: string; description?: string }) => {
      return updateIssue(id, data);
    },
    onSuccess: (data) => {
      // Invalidate relevant queries
      queryClient.invalidateQueries({ queryKey: ['issues'] });
    },
  });
}
```

## 8. Handle Empty Description
**File:** `src/features/kanban/components/task-description-editor.tsx`

**Check:** Empty string should save correctly:
```typescript
// Don't skip save for empty string - user may want to clear description
const handleBlur = () => {
  if (value !== initialDescription) {  // '' !== 'old text' = save
    updateMutation.mutate({ id: taskId, description: value });
  }
};
```

## Verification Checklist
- [ ] Open InfoSidebar (prerequisite: ISSUE-5.6 fixed)
- [ ] New task shows "Add a description..." placeholder
- [ ] Task with existing description shows that text
- [ ] Edit text → blur → "Saved" indicator appears
- [ ] Edit text → Cmd+Enter → "Saved" indicator appears
- [ ] Refresh page → edited description persists
- [ ] Clear all text → blur → empty description persists

## Files to Verify
| File | Check |
|------|-------|
| `src/features/kanban/components/task-description-editor.tsx` | onBlur and onKeyDown handlers |
| `src/features/kanban/components/task-card.tsx` | initialDescription passed correctly |
| `src/app/api/issues/[id]/route.ts` | PATCH accepts description |
| `src/services/issue-service.ts` | Service updates description |

## Related Specs
- `5.2-task-card-editor.md` - Original implementation spec
- `5.6-fix-infobar-rendering.md` - Prerequisite fix
