# Spec: Phase 5.3 - Drag Persistence & API

> **Goal:** Implement persistent drag-and-drop reordering and column moves.
> **Context:** Currently, DND is visual-only or only persists status, not order.

## 1. Schema Migration
**File:** `src/lib/db/schema.ts`
- **Action:** Add `sortOrder` column to `issues`.
  ```typescript
  sortOrder: real('sort_order').notNull().default(0)
  ```
- **Execution:**
  - Update schema file.
  - Run `pnpm drizzle-kit generate` (creates SQL).
  - Run `pnpm drizzle-kit migrate` (applies to DB).

## 2. API Endpoint
**File:** `src/app/api/issues/[id]/move/route.ts` (Create New)
- **Method:** `PUT`
- **Contract:**
  - Input: `{ status: string, prevIssueId: string | null, nextIssueId: string | null }`
  - Logic:
    - Fetch `prev` and `next` issues to get their `sortOrder`.
    - Calculate new `sortOrder`:
      - If between A and B: `(A.sortOrder + B.sortOrder) / 2`
      - If first: `next.sortOrder - 1000` (or min - 1000)
      - If last: `prev.sortOrder + 1000` (or max + 1000)
      - If empty column: `0` (or max + 1000)
    - Update issue `status` and `sortOrder`.
  - Output: `{ success: true, data: Issue }`

## 3. Frontend Integration
**File:** `src/features/kanban/components/kanban-board.tsx`
- **Action:** Update `onDragEnd` handler.
- **Logic:**
  - Determine `prevIssueId` and `nextIssueId` based on the *new* position in the `tasks` array.
  - Call mutation `moveIssue({ id, status, prevIssueId, nextIssueId })`.

## 4. Optimistic Updates
**File:** `src/features/kanban/hooks/use-column-mutations.ts`
- **Action:** Implement `onMutate` for `moveIssue`.
  - Cancel outgoing refetches.
  - Snapshot previous state.
  - Manually update QueryCache `['issues', { parentId }]`:
    - Move task to new column array.
    - Splice into new index.
    - (Optional) approximate `sortOrder` locally to prevent jumpiness on refetch.

## 5. Verification
- [ ] Drag task to new position (reorder). Refresh page. Verify position persists.
- [ ] Move task to new column. Refresh. Verify column persists.
