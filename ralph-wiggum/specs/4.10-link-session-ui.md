# Work Plan: 4.10 Link Session UI

## Context

### Original Request
Create an interface to search and link OpenCode sessions to Kanban tasks.

### Interview Summary
**Key Discussions**:
- Backend API exists: `POST/GET /api/issues/[id]/sessions`
- Sessions available via `GET /api/sessions` (returns up to 100 sessions)
- No search param on API - filter client-side
- Need LinkSessionDialog component triggered from task details
- Need mutation hooks for link/unlink operations

**Research Findings**:
- `/api/sessions/route.ts:L11-14`: Returns `{ sessions, projects }` 
- `/api/issues/[id]/sessions/route.ts`: Full CRUD - POST to link, GET to list links
- DELETE endpoint needed - check if exists for unlink
- Sessions have: id, date, summary/preview

### Spec Reference
- `ralph-wiggum/specs/4.10-link-session-ui.md`

---

## Work Objectives

### Core Objective
Enable users to link OpenCode sessions to tasks via a dialog interface.

### Concrete Deliverables
- `OpenKanban/src/features/sessions/hooks/use-session-mutations.ts` - Mutation hooks
- `OpenKanban/src/features/sessions/hooks/use-sessions.ts` - Query hook for sessions
- `OpenKanban/src/features/sessions/components/link-session-dialog.tsx` - Dialog component
- Updated task details to show linked sessions

### Definition of Done
- [ ] LinkSessionDialog opens from task details
- [ ] Users can search/filter available sessions
- [ ] Users can link a session to a task
- [ ] Linked sessions appear in task details
- [ ] Users can unlink a session (remove link)
- [ ] `pnpm run build` passes
- [ ] `pnpm run lint` passes

### Must Have
- Session list with search/filter
- Link button for each session
- Display linked sessions in task details
- Unlink button for linked sessions
- Loading states

### Must NOT Have (Guardrails)
- Session viewer/preview (future)
- Session creation from this UI
- Complex search API - client-side filter is fine for v1

---

## Verification Strategy

### Test Decision
- **Approach**: Manual verification with browser automation
- **QA approach**: End-to-end flow testing

---

## Task Flow

```
Task 1 (Types) → Task 2 (Hooks) → Task 3 (Dialog) → Task 4 (Integration)
```

## Parallelization

| Task | Depends On | Reason |
|------|------------|--------|
| 1 | None | Type definitions first |
| 2 | 1 | Needs types |
| 3 | 2 | Needs hooks |
| 4 | 3 | Needs dialog |

---

## TODOs

- [ ] 1. Create Session Types and Query Keys

  **What to do**:
  - Create `OpenKanban/src/features/sessions/types.ts`
  - Define `Session` and `SessionLink` types
  - Add session query keys to `OpenKanban/src/lib/query-keys.ts`

  **Must NOT do**:
  - Don't overcomplicate types (start minimal)

  **Parallelizable**: NO (must complete first)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/lib/query-keys.ts` - Query key patterns
  - `OpenKanban/src/app/api/sessions/route.ts:L11-14` - Session data shape

  **Code to Create** (types.ts):
  ```typescript
  /**
   * OpenCode Session metadata for linking to issues.
   * @see src/contract/opencode/schemas.ts:L32-41 - SessionSchema
   */
  export interface Session {
    id: string;
    title: string;
    slug: string;
    projectID: string;
    directory: string;
    parentID?: string | null;
    time: {
      created: number;
      updated: number;
      initialized?: number;
    };
    summary?: {
      additions?: number;
      deletions?: number;
      files?: number;
    };
  }

  /**
   * Link between an issue and a session.
   */
  export interface SessionLink {
    id: string;
    issueId: string;
    sessionId: string;
    linkType?: string | null;
    createdAt: string;
  }

  /**
   * API response shape from GET /api/sessions
   */
  export interface SessionsResponse {
    success: boolean;
    data: {
      sessions: Session[];
      projects: unknown[]; // OpenCode projects, not used here
    };
  }
  ```

  **Add to query-keys.ts**:
  ```typescript
  /**
   * Sessions list query key.
   * Used by: useSessions hook
   */
  sessions: ['sessions'] as const,

  /**
   * Issue session links query key factory.
   * Used by: useSessionLinks hook
   *
   * @param issueId - Issue ID to get linked sessions for
   */
  issueSessionLinks: (issueId: string) =>
    ['issue-session-links', issueId] as const,
  ```

  **Directory Structure**:
  ```
  src/features/sessions/
  ├── types.ts
  ├── hooks/
  │   ├── use-sessions.ts
  │   └── use-session-mutations.ts
  └── components/
      └── link-session-dialog.tsx
  ```

  **Acceptance Criteria**:
  - [ ] `src/features/sessions/types.ts` exists
  - [ ] `Session` and `SessionLink` types defined
  - [ ] Query keys added to `query-keys.ts`
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(sessions): add session types and query keys`
  - Files: `src/features/sessions/types.ts`, `src/lib/query-keys.ts`

---

- [ ] 2. Create Session Query and Mutation Hooks

  **What to do**:
  - Create `OpenKanban/src/features/sessions/hooks/use-sessions.ts`
  - Create `OpenKanban/src/features/sessions/hooks/use-session-mutations.ts`
  - Implement `useSessions` hook to fetch all sessions
  - Implement `useSessionLinks` hook to fetch linked sessions for an issue
  - Implement `useLinkSession` mutation hook
  - Create directory structure as needed

  **Must NOT do**:
  - Don't add unlink mutation yet (focus on link)
  - Don't add complex caching logic

  **Parallelizable**: NO (depends on 1)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/projects/hooks/use-projects.ts` - Query hook pattern
  - `OpenKanban/src/features/boards/hooks/use-board-mutations.ts` - Mutation hook pattern

  **API References**:
  - `GET /api/sessions` - Returns `{ success, data: { sessions, projects } }`
  - `GET /api/issues/[id]/sessions` - Returns `{ success, data: SessionLink[] }`
  - `POST /api/issues/[id]/sessions` - Body: `{ sessionId, linkType? }`

  **Code for use-sessions.ts**:
  ```typescript
  'use client';

  import { useQuery } from '@tanstack/react-query';
  import { queryKeys } from '@/lib/query-keys';
  import type { Session, SessionsResponse } from '../types';

  async function fetchSessions(): Promise<Session[]> {
    const response = await fetch('/api/sessions');
    if (!response.ok) {
      throw new Error('Failed to fetch sessions');
    }
    const data: SessionsResponse = await response.json();
    if (!data.success) {
      throw new Error('Failed to fetch sessions');
    }
    return data.data.sessions;
  }

  export function useSessions() {
    const query = useQuery({
      queryKey: queryKeys.sessions,
      queryFn: fetchSessions,
    });

    return {
      sessions: query.data ?? [],
      isLoading: query.isLoading,
      error: query.error,
    };
  }
  ```

  **Code for use-session-mutations.ts**:
  ```typescript
  'use client';

  import { useMutation, useQueryClient } from '@tanstack/react-query';
  import { queryKeys } from '@/lib/query-keys';
  import { logger } from '@/lib/logger';

  interface LinkSessionParams {
    issueId: string;
    sessionId: string;
    linkType?: string;
  }

  interface UnlinkSessionParams {
    issueId: string;
    sessionId: string;
  }

  async function linkSession({ issueId, sessionId, linkType }: LinkSessionParams) {
    const response = await fetch(`/api/issues/${issueId}/sessions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, linkType }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error?.message ?? 'Failed to link session');
    }

    return response.json();
  }

  async function unlinkSession({ issueId, sessionId }: UnlinkSessionParams) {
    const response = await fetch(`/api/issues/${issueId}/sessions/${sessionId}`, {
      method: 'DELETE',
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error?.message ?? 'Failed to unlink session');
    }

    return response.json();
  }

  export function useLinkSession() {
    const queryClient = useQueryClient();

    return useMutation({
      mutationFn: linkSession,
      onSuccess: (_, variables) => {
        void queryClient.invalidateQueries({
          queryKey: queryKeys.issueSessionLinks(variables.issueId),
        });
      },
      onError: (error) => {
        logger.error('Failed to link session', { error: String(error) });
      },
    });
  }

  export function useUnlinkSession() {
    const queryClient = useQueryClient();

    return useMutation({
      mutationFn: unlinkSession,
      onSuccess: (_, variables) => {
        void queryClient.invalidateQueries({
          queryKey: queryKeys.issueSessionLinks(variables.issueId),
        });
      },
      onError: (error) => {
        logger.error('Failed to unlink session', { error: String(error) });
      },
    });
  }

  // Hook to fetch linked sessions for an issue
  export function useSessionLinks(issueId: string) {
    const query = useQuery({
      queryKey: queryKeys.issueSessionLinks(issueId),
      queryFn: async () => {
        const response = await fetch(`/api/issues/${issueId}/sessions`);
        if (!response.ok) {
          throw new Error('Failed to fetch session links');
        }
        const data = await response.json();
        if (!data.success) {
          throw new Error('Failed to fetch session links');
        }
        return data.data;
      },
      enabled: Boolean(issueId),
    });

    return {
      sessionLinks: query.data ?? [],
      isLoading: query.isLoading,
      error: query.error,
    };
  }
  ```

  **Acceptance Criteria**:
  - [ ] `use-sessions.ts` exports `useSessions` hook
  - [ ] `use-session-mutations.ts` exports `useLinkSession` and `useSessionLinks`
  - [ ] Hooks follow existing patterns (useQuery/useMutation)
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(sessions): add session query and mutation hooks`
  - Files: `src/features/sessions/hooks/use-sessions.ts`, `src/features/sessions/hooks/use-session-mutations.ts`

---

- [ ] 3. Create LinkSessionDialog Component

  **What to do**:
  - Create `OpenKanban/src/features/sessions/components/link-session-dialog.tsx`
  - Dialog with search input and session list
  - Each session has "Link" button
  - Filter sessions client-side by search query
  - Exclude already-linked sessions from list

  **Must NOT do**:
  - Don't add session preview/viewer
  - Don't add multi-select (one at a time)
  - Don't over-complicate the UI

  **Parallelizable**: NO (depends on 2)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/boards/components/create-board-dialog.tsx` - Dialog pattern
  - `OpenKanban/src/components/ui/dialog.tsx` - shadcn Dialog component

  **Component References**:
  - `@/components/ui/dialog` - Dialog, DialogContent, DialogHeader, etc.
  - `@/components/ui/input` - Search input
  - `@/components/ui/button` - Link button

  **Code Template**:
  ```typescript
  'use client';

  import { useState, useMemo } from 'react';
  import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
  } from '@/components/ui/dialog';
  import { Input } from '@/components/ui/input';
  import { Button } from '@/components/ui/button';
  import { Skeleton } from '@/components/ui/skeleton';
  import { useSessions } from '../hooks/use-sessions';
  import { useLinkSession, useSessionLinks } from '../hooks/use-session-mutations';
  import { IconLink, IconSearch } from '@tabler/icons-react';

  interface LinkSessionDialogProps {
    issueId: string;
    issueTitle: string;
    isOpen: boolean;
    onClose: () => void;
  }

  export function LinkSessionDialog({
    issueId,
    issueTitle,
    isOpen,
    onClose,
  }: LinkSessionDialogProps) {
    const [searchQuery, setSearchQuery] = useState('');
    const { sessions, isLoading: sessionsLoading } = useSessions();
    const { sessionLinks } = useSessionLinks(issueId);
    const linkSession = useLinkSession();

    // Filter out already linked sessions and apply search
    const availableSessions = useMemo(() => {
      const linkedIds = new Set(sessionLinks.map((link: { sessionId: string }) => link.sessionId));
      return sessions
        .filter((session) => !linkedIds.has(session.id))
        .filter((session) => {
          if (!searchQuery) return true;
          const query = searchQuery.toLowerCase();
          return (
            session.id.toLowerCase().includes(query) ||
            session.title?.toLowerCase().includes(query) ||
            session.slug?.toLowerCase().includes(query)
          );
        });
    }, [sessions, sessionLinks, searchQuery]);

    const handleLink = async (sessionId: string) => {
      try {
        await linkSession.mutateAsync({ issueId, sessionId });
        // Optionally close dialog or show success
      } catch {
        // Error handled in hook
      }
    };

    return (
      <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <DialogTitle>Link Session</DialogTitle>
            <DialogDescription>
              Link an OpenCode session to &quot;{issueTitle}&quot;
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4">
            {/* Search Input */}
            <div className="relative">
              <IconSearch className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
              <Input
                placeholder="Search sessions..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9"
              />
            </div>

            {/* Session List */}
            <div className="max-h-[300px] overflow-y-auto space-y-2">
              {sessionsLoading ? (
                <>
                  <Skeleton className="h-12 w-full" />
                  <Skeleton className="h-12 w-full" />
                  <Skeleton className="h-12 w-full" />
                </>
              ) : availableSessions.length === 0 ? (
                <div className="text-center py-4 text-sm text-muted-foreground">
                  {searchQuery
                    ? 'No sessions match your search'
                    : 'No sessions available to link'}
                </div>
              ) : (
                availableSessions.map((session) => (
                  <div
                    key={session.id}
                    className="flex items-center justify-between p-3 border rounded-lg"
                  >
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium truncate">
                        {session.title || session.slug}
                      </p>
                      {session.summary && (
                        <p className="text-xs text-muted-foreground truncate">
                          +{session.summary.additions ?? 0} / -{session.summary.deletions ?? 0} ({session.summary.files ?? 0} files)
                        </p>
                      )}
                      {session.time?.created && (
                        <p className="text-xs text-muted-foreground">
                          {new Date(session.time.created).toLocaleDateString()}
                        </p>
                      )}
                    </div>
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => handleLink(session.id)}
                      disabled={linkSession.isPending}
                    >
                      <IconLink className="h-4 w-4 mr-1" />
                      Link
                    </Button>
                  </div>
                ))
              )}
            </div>
          </div>
        </DialogContent>
      </Dialog>
    );
  }
  ```

  **Acceptance Criteria**:
  - [ ] `link-session-dialog.tsx` exists
  - [ ] Dialog shows search input and session list
  - [ ] Already-linked sessions are filtered out
  - [ ] Search filters by session ID and summary
  - [ ] Link button calls mutation
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(sessions): create LinkSessionDialog component`
  - Files: `src/features/sessions/components/link-session-dialog.tsx`

---

- [ ] 4. Create Feature Barrel Export

  **What to do**:
  - Create `OpenKanban/src/features/sessions/index.ts`
  - Export all hooks and components

  **Must NOT do**:
  - Don't export internal implementation details

  **Parallelizable**: NO (depends on 3)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/boards/index.ts` - Barrel export pattern

  **Code**:
  ```typescript
  // Components
  export { LinkSessionDialog } from './components/link-session-dialog';

  // Hooks
  export { useSessions } from './hooks/use-sessions';
  export { useLinkSession, useUnlinkSession, useSessionLinks } from './hooks/use-session-mutations';

  // Types
  export type { Session, SessionLink, SessionsResponse } from './types';
  ```

  **Acceptance Criteria**:
  - [ ] `src/features/sessions/index.ts` exists
  - [ ] All public APIs exported
  - [ ] `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(sessions): add feature barrel export`
  - Files: `src/features/sessions/index.ts`

---

- [ ] 5. Integrate with Task Details (Infobar)

  **What to do**:
  - Find where task details are shown (likely infobar or task detail panel)
  - Add "Link Session" button
  - Show linked sessions list
  - Wire up LinkSessionDialog

  **Must NOT do**:
  - Don't redesign the entire task detail panel
  - Don't add session preview/viewing

  **Parallelizable**: NO (depends on 4)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/kanban/components/task-card.tsx:L53-70` - Infobar usage
  - `OpenKanban/src/components/ui/infobar.tsx` - Infobar component

  **Discovery Required**:
  - Examine how task details are currently displayed
  - Identify integration point for "Link Session" button
  - May need to update `InfobarContent` type

  **Integration Approach**:
  
  Option A: Add to existing infobar sections
  ```typescript
  const content: InfobarContent = {
    title: task.title,
    sections: [
      {
        title: 'Description',
        description: task.description || 'No description provided.',
        links: []
      },
      // NEW: Sessions section
      {
        title: 'Linked Sessions',
        description: linkedSessions.length ? undefined : 'No sessions linked',
        links: linkedSessions.map(link => ({
          label: link.sessionId,
          href: '#', // Future: session viewer
        })),
      }
    ],
    // NEW: Action button
    actions: [
      { label: 'Link Session', onClick: () => setShowLinkDialog(true) }
    ]
  };
  ```

  Option B: Create dedicated TaskDetailPanel component
  - If infobar is too limited, create new panel component

  **Acceptance Criteria**:

  **Manual Verification** (using Playwright):
  - [ ] Navigate to: `http://localhost:37291/project/[projectId]/board/[boardId]`
  - [ ] Click on a task card
  - [ ] Verify: Task details panel/infobar opens
  - [ ] Verify: "Link Session" button visible
  - [ ] Action: Click "Link Session"
  - [ ] Verify: LinkSessionDialog opens
  - [ ] Action: Search for a session
  - [ ] Action: Click "Link" on a session
  - [ ] Verify: Session added to linked list
  - [ ] Screenshot: Save to `.sisyphus/evidence/4.10-link-session.png`

  **Build Verification**:
  - [ ] `pnpm run build` → 0 errors
  - [ ] `pnpm run lint` → 0 errors

  **Commit**: YES
  - Message: `feat(kanban): integrate LinkSessionDialog with task details`
  - Files: Depends on integration approach (task-card.tsx or new component)

---

## Commit Strategy

| After Task | Message | Files | Verification |
|------------|---------|-------|--------------|
| 1 | `feat(sessions): add session types and query keys` | types.ts, query-keys.ts | pnpm build |
| 2 | `feat(sessions): add session hooks` | use-sessions.ts, use-session-mutations.ts | pnpm build |
| 3 | `feat(sessions): create LinkSessionDialog` | link-session-dialog.tsx | pnpm build |
| 4 | `feat(sessions): add feature barrel export` | index.ts | pnpm build |
| 5 | `feat(kanban): integrate LinkSessionDialog` | TBD | pnpm build + manual test |

---

## Success Criteria

### Verification Commands
```bash
pnpm run build  # Expected: 0 errors
pnpm run lint   # Expected: 0 errors
```

### Final Checklist
- [ ] LinkSessionDialog component works
- [ ] Sessions can be searched/filtered
- [ ] Sessions can be linked to tasks
- [ ] Linked sessions visible in task details
- [ ] Already-linked sessions excluded from list
- [ ] Build and lint pass
