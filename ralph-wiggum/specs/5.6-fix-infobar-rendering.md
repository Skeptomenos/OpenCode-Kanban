# Spec: Phase 5.6 - Fix InfoSidebar Rendering Bug

> **Goal:** Fix the InfoSidebar panel so it visually renders when a task card is clicked.
> **Context:** Clicking a task card calls `setOpen(true)` but the panel doesn't appear visually, despite elements existing in the accessibility tree.
> **Priority:** P0 - Critical (blocks task editing and session linking)

## Background

The InfoSidebar is designed to show task details, a description editor, and session linking options when a user clicks on a task card. Currently:
- The click handler in `task-card.tsx` correctly calls `setContent()` and `setOpen(true)`
- Accessibility tree shows all elements (Task title, Description textbox, "Link Session" button)
- Visual rendering shows empty space where the panel should be

## Root Cause Analysis

The `Infobar` component in `infobar.tsx` uses conditional rendering based on `isMobile`:
- **Mobile (< 768px):** Renders inside a Radix `Sheet` component
- **Desktop (>= 768px):** Renders a `div` with `hidden md:block` classes

The bug occurs because:
1. **Line 294**: Desktop container has `hidden md:block` - if viewport is below `md` breakpoint but `isMobile` returns `false`, nothing renders
2. **Line 310-311**: Inner container uses `w-(--infobar-width)` transitioning to `w-0` via `group-data-[collapsible=offcanvas]:w-0`
3. **State Initialization**: `InfobarProvider` may initialize with `defaultOpen={false}`, keeping `state="collapsed"` and `width=0`

## 1. Verify Hook Breakpoint Sync
**File:** `src/hooks/use-mobile.tsx`

```typescript
// Current implementation (Line 3)
const MOBILE_BREAKPOINT = 768;

// Line 11 - Uses max-width: 767px
const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
```

**Verification:** This matches Tailwind's `md` breakpoint (768px). No change needed if correct.

## 2. Fix Initial State Hydration
**File:** `src/hooks/use-mobile.tsx`

**Problem:** `isMobile` starts as `undefined`, converted to `false` by `!!isMobile` (Line 20). During SSR/hydration, the hook returns `false` even on mobile devices.

**Action:** Consider initial state handling:
```typescript
// Option A: Return undefined during hydration to prevent mismatch
export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined);
  // ...
  return isMobile; // Return undefined, not !!isMobile
}

// Then in infobar.tsx, handle undefined state
if (isMobile === undefined) {
  return <InfobarSkeleton />; // or null during hydration
}
```

## 3. Debug State Propagation
**File:** `src/components/ui/infobar.tsx`

**Action:** Add temporary logging to trace the issue:

```typescript
// In Infobar component (around Line 245)
function Infobar({ side = 'right', variant = 'infobar', collapsible = 'offcanvas', className, children, ...props }: InfobarProps) {
  const { isMobile, state, open, openMobile, isPathnameChanging } = useInfobar();
  
  // DEBUG: Remove after fixing
  console.log('[Infobar Debug]', { isMobile, state, open, openMobile });
  
  // ... rest of component
}
```

## 4. Fix CSS Visibility Conditions
**File:** `src/components/ui/infobar.tsx`

**Problem Area (Lines 292-328):**
```tsx
// Desktop rendering path
return (
  <div
    className='group peer text-sidebar-foreground hidden md:block'  // <- ISSUE: hidden on mobile
    data-state={state}  // <- Controls width via group-data selectors
    // ...
  >
    <div
      data-slot='infobar-container'
      className={cn(
        'relative hidden h-full w-(--infobar-width) ... md:flex',  // <- ISSUE: hidden on mobile
        'group-data-[collapsible=offcanvas]:w-0 ...',  // <- ISSUE: w-0 when collapsed
      )}
    >
```

**Mitigation Strategy:**
1. Ensure `state` transitions from `collapsed` to `expanded` when `setOpen(true)` is called
2. Check that `data-state="expanded"` removes the `w-0` override

**Debug Check:**
```typescript
// In browser DevTools, after clicking a task card:
// 1. Find element with data-slot="infobar-container"
// 2. Check computed styles for 'width'
// 3. If width is 0, check data-state attribute on parent
// 4. If data-state="collapsed", the setOpen(true) call is not working
```

## 5. Verify Layout Container
**File:** `src/app/project/[projectId]/layout.tsx`

**Action:** Verify `InfobarProvider` wraps the layout and `InfoSidebar` is rendered:

```typescript
// Expected structure:
<InfobarProvider defaultOpen={false}>
  <SidebarProvider>
    <AppSidebar />
    <SidebarInset>
      {/* Board content */}
    </SidebarInset>
    <InfoSidebar />  {/* Must be OUTSIDE SidebarInset */}
  </SidebarProvider>
</InfobarProvider>
```

**Check:** If `InfoSidebar` is inside `SidebarInset`, the flex layout may not allocate space correctly.

## 6. Test Click Handler
**File:** `src/features/kanban/components/task-card.tsx`

**Verify `handleCardClick` (Lines 79-102):**
```typescript
const handleCardClick = () => {
  if (isOverlay || isDragging) return;  // Ensure not blocked by drag state
  
  const content: InfobarContent = {
    title: task.title,
    sections: [/* ... */],
    actions: <TaskInfobarActions taskId={task.id} taskTitle={task.title} />
  };
  
  setContent(content);  // Sets the content to display
  setOpen(true);        // Should trigger state change
};
```

**Debug:** Add `console.log` before `setOpen(true)` to confirm the function executes.

## Verification Checklist
- [ ] Click task card, confirm `console.log` fires in `handleCardClick`
- [ ] Confirm `[Infobar Debug]` shows `state: 'expanded'` after click
- [ ] Confirm `data-slot="infobar-container"` has computed width > 0
- [ ] Confirm InfoSidebar visually appears with task title
- [ ] Confirm description editor (`<textarea>`) is visible and editable
- [ ] Confirm "Link Session" and "Create Branch" buttons are visible

## Files to Modify
| File | Action |
|------|--------|
| `src/hooks/use-mobile.tsx` | Consider hydration handling |
| `src/components/ui/infobar.tsx` | Add debug logging, check state logic |
| `src/app/project/[projectId]/layout.tsx` | Verify InfoSidebar placement |
| `src/features/kanban/components/task-card.tsx` | Add debug logging |

## Related Specs
- `5.1-sidebar-overhaul.md` - Layout structure reference
- `5.2-task-card-editor.md` - TaskDescriptionEditor integration
