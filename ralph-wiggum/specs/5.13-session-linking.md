# Spec: Phase 5.13 - Session Linking Functionality

> **Goal:** Verify and complete the session linking feature.
> **Context:** "Link Session" button exists in InfoSidebar but functionality was not tested.
> **Priority:** P3 - Low (blocked by ISSUE-5.6)
> **Prerequisite:** Fix ISSUE-5.6 (InfoSidebar rendering) first

## Background

OpenKanban's core value proposition is linking OpenCode sessions to tasks as "evidence" or "implementation details". The feature should:
1. Allow searching for sessions by title/date
2. Link selected session(s) to the current task
3. Display linked sessions in the InfoSidebar
4. Allow viewing session transcripts

## Data Model

**Sessions Table (via OpenCode adapter):**
```typescript
// Read from ~/.local/share/opencode/storage/
interface Session {
  id: string;
  title: string;
  createdAt: number;
  messageCount: number;
}
```

**Issue-Session Link Table:**
```sql
CREATE TABLE issue_sessions (
  issue_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  linked_at INTEGER NOT NULL,
  PRIMARY KEY (issue_id, session_id),
  FOREIGN KEY (issue_id) REFERENCES issues(id) ON DELETE CASCADE
);
```

## 1. Verify Link Session Button
**File:** `src/features/kanban/components/task-infobar-actions.tsx`

**Expected Structure:**
```tsx
import { LinkSessionDialog } from '@/features/sessions/components/link-session-dialog';

export function TaskInfobarActions({ taskId, taskTitle }: Props) {
  return (
    <div className="flex flex-col gap-2">
      <LinkSessionDialog taskId={taskId}>
        <Button variant="outline" size="sm">
          <IconLink className="h-4 w-4 mr-2" />
          Link Session
        </Button>
      </LinkSessionDialog>
      
      <Button variant="outline" size="sm">
        <IconGitBranch className="h-4 w-4 mr-2" />
        Create Branch
      </Button>
    </div>
  );
}
```

## 2. Verify LinkSessionDialog Component
**File:** `src/features/sessions/components/link-session-dialog.tsx`

**Expected Props:**
```typescript
interface LinkSessionDialogProps {
  taskId: string;
  children: React.ReactNode;
}
```

**Expected Behavior:**
1. Opens dialog on trigger click
2. Fetches available sessions from OpenCode adapter
3. Displays searchable list
4. Allows selecting one or more sessions
5. Links selected sessions on confirm

**Expected Structure:**
```tsx
export function LinkSessionDialog({ taskId, children }: Props) {
  const [open, setOpen] = useState(false);
  const [search, setSearch] = useState('');
  const [selected, setSelected] = useState<string[]>([]);
  
  const { data: sessions } = useSessions();  // Fetch from /api/sessions
  const linkMutation = useLinkSessionMutation();
  
  const filteredSessions = sessions?.filter(s => 
    s.title.toLowerCase().includes(search.toLowerCase())
  );
  
  const handleLink = () => {
    selected.forEach(sessionId => {
      linkMutation.mutate({ issueId: taskId, sessionId });
    });
    setOpen(false);
  };
  
  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>{children}</DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Link Session</DialogTitle>
        </DialogHeader>
        
        <Input
          placeholder="Search sessions..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
        />
        
        <div className="max-h-64 overflow-y-auto">
          {filteredSessions?.map(session => (
            <div 
              key={session.id}
              onClick={() => toggleSelect(session.id)}
              className={cn(
                'p-2 cursor-pointer',
                selected.includes(session.id) && 'bg-accent'
              )}
            >
              <p className="font-medium">{session.title}</p>
              <p className="text-xs text-muted-foreground">
                {formatDate(session.createdAt)}
              </p>
            </div>
          ))}
        </div>
        
        <Button onClick={handleLink} disabled={selected.length === 0}>
          Link {selected.length} session(s)
        </Button>
      </DialogContent>
    </Dialog>
  );
}
```

## 3. Verify Sessions API
**File:** `src/app/api/sessions/route.ts`

**Expected GET handler:**
```typescript
import { OpenCodeService } from '@/services/opencode-service';

export async function GET() {
  const sessions = await OpenCodeService.listSessions();
  return NextResponse.json({ success: true, data: sessions });
}
```

**File:** `src/services/opencode-service.ts`

**Expected:**
```typescript
export class OpenCodeService {
  static async listSessions(): Promise<Session[]> {
    const storagePath = path.join(
      process.env.HOME ?? '',
      '.local/share/opencode/storage'
    );
    
    // Read session metadata from filesystem
    const sessionDirs = await fs.readdir(storagePath);
    // Parse and return sessions
  }
}
```

## 4. Verify Link Session API
**File:** `src/app/api/issues/[id]/sessions/route.ts`

**Expected POST handler:**
```typescript
export async function POST(request: Request, { params }: RouteParams) {
  const { sessionId } = await request.json();
  
  const link = await issueSessionRepository.create({
    issueId: params.id,
    sessionId,
    linkedAt: Date.now(),
  });
  
  return NextResponse.json({ success: true, data: link });
}
```

**Expected GET handler:**
```typescript
export async function GET(request: Request, { params }: RouteParams) {
  const links = await issueSessionRepository.findByIssueId(params.id);
  
  // Optionally enrich with session metadata
  const sessions = await Promise.all(
    links.map(link => OpenCodeService.getSession(link.sessionId))
  );
  
  return NextResponse.json({ success: true, data: sessions });
}
```

## 5. Verify Linked Sessions Display
**File:** `src/components/layout/info-sidebar.tsx` or `src/features/kanban/components/task-infobar-actions.tsx`

**Expected:** Display linked sessions below the link button:
```tsx
function LinkedSessions({ taskId }: { taskId: string }) {
  const { data: sessions } = useLinkedSessions(taskId);
  
  if (!sessions?.length) {
    return <p className="text-sm text-muted-foreground">No sessions linked</p>;
  }
  
  return (
    <div className="space-y-2">
      <h4 className="text-sm font-medium">Linked Sessions</h4>
      {sessions.map(session => (
        <SessionCard key={session.id} session={session} />
      ))}
    </div>
  );
}
```

## 6. Verify Unlink Functionality
**File:** `src/app/api/issues/[id]/sessions/[sessionId]/route.ts`

**Expected DELETE handler:**
```typescript
export async function DELETE(request: Request, { params }: RouteParams) {
  await issueSessionRepository.delete({
    issueId: params.id,
    sessionId: params.sessionId,
  });
  
  return NextResponse.json({ success: true });
}
```

## Verification Checklist

### Prerequisites
- [ ] ISSUE-5.6 fixed (InfoSidebar renders)

### Link Session Flow
- [ ] Click task card â†’ InfoSidebar opens
- [ ] Click "Link Session" button
- [ ] Dialog opens with session list
- [ ] Search filters sessions
- [ ] Select session(s)
- [ ] Click link button
- [ ] Dialog closes
- [ ] Linked sessions appear in sidebar

### Persistence
- [ ] Refresh page
- [ ] Open same task
- [ ] Linked sessions still displayed

### Unlink Flow
- [ ] Click unlink/remove on linked session
- [ ] Session removed from list
- [ ] Persists after refresh

## Files to Verify/Create
| File | Status | Action |
|------|--------|--------|
| `src/features/kanban/components/task-infobar-actions.tsx` | Exists | Verify Link Session button |
| `src/features/sessions/components/link-session-dialog.tsx` | Unknown | Create if missing |
| `src/app/api/sessions/route.ts` | Unknown | Verify or create |
| `src/app/api/issues/[id]/sessions/route.ts` | Exists | Verify GET/POST |
| `src/services/opencode-service.ts` | Exists | Verify listSessions |

## Related Specs
- `5.5-deferred-features.md` - Session integration marked as deferred
- Phase 2 specs - Session linking API
