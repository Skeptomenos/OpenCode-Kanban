# Spec: Phase 5.14 - Create Branch from Task

> **Goal:** Implement the "Create Branch" workflow from a task.
> **Context:** A "Create Branch" button exists in the InfoSidebar but is currently a placeholder.
> **Priority:** P3 - Low (Nice to have / Deferred)
> **Prerequisite:** Fix ISSUE-5.6 (InfoSidebar rendering) first

## Background

To tighten the loop between planning and coding, users should be able to create a git branch directly from a Kanban task.
Format: `feature/{issue-id}-{slugified-title}` or `fix/{issue-id}-{slugified-title}`.

## 1. Verify UI Trigger
**File:** `src/features/kanban/components/task-infobar-actions.tsx`

**Current State:**
```tsx
<Button variant="outline" size="sm">
  <IconGitBranch className="h-4 w-4 mr-2" />
  Create Branch
</Button>
```

**Required Change:**
Wrap in a Dialog or Popover to confirm branch name.

```tsx
<CreateBranchDialog task={task}>
  <Button variant="outline" size="sm">
    <IconGitBranch className="h-4 w-4 mr-2" />
    Create Branch
  </Button>
</CreateBranchDialog>
```

## 2. Create Dialog Component
**File:** `src/features/git/components/create-branch-dialog.tsx`

**Requirements:**
- Input for branch type (feature, fix, chore)
- Input for branch name (pre-filled with slugified task title)
- Preview of final branch name
- "Create" button

**Slugification Logic:**
```typescript
const slug = task.title
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, '-')
  .replace(/^-+|-+$/g, '');
const defaultBranch = `feature/${task.id}-${slug}`;
```

## 3. API Endpoint (Git Operation)
**File:** `src/app/api/git/branches/route.ts`

**Method:** `POST`
**Body:** `{ branchName: string, sourceBranch: string }`

**Implementation:**
Since this is a local-first app, it needs to execute git commands in the user's workspace.
*Note: This might require an MCP tool or a server-side execution context that has access to the user's shell, OR this feature might be intended to just copy the branch name to clipboard if direct git execution isn't safe/scoped.*

**Constraint Check:**
If the app runs in a restricted container, it might not be able to run `git checkout -b`.
**Fallback:** "Copy Branch Name" to clipboard.

**Decision:** Implement "Copy to Clipboard" first (safest), with "Run Command" as an advanced option if `OpenCodeService` permits shell execution.

## 4. Implementation (Clipboard Fallback)
**File:** `src/features/git/components/create-branch-dialog.tsx`

```tsx
const handleCopy = () => {
  navigator.clipboard.writeText(`git checkout -b ${branchName}`);
  toast.success('Git command copied to clipboard');
  setOpen(false);
};
```

## 5. Implementation (Direct Execution - Advanced)
**File:** `src/services/git-service.ts`

If server-side execution is permitted:
```typescript
import { exec } from 'child_process';
import { promisify } from 'util';
const execAsync = promisify(exec);

export async function createBranch(name: string) {
  // DANGER: Needs strict validation to prevent injection
  if (!/^[a-z0-9\/\-]+$/.test(name)) throw new Error("Invalid branch name");
  
  await execAsync(`git checkout -b ${name}`);
}
```

**Recommendation:** Stick to Clipboard Copy for Phase 5. Direct execution requires deeper security audit.

## Verification
- [ ] Click "Create Branch"
- [ ] Dialog opens with pre-filled name `feature/id-title`
- [ ] Can edit branch name
- [ ] Clicking "Copy" copies `git checkout -b ...` to clipboard
- [ ] Toast confirms action

## Files to Create/Modify
| File | Action |
|------|--------|
| `src/features/kanban/components/task-infobar-actions.tsx` | Wire up dialog |
| `src/features/git/components/create-branch-dialog.tsx` | Create component |
| `src/lib/utils/string.ts` | Add slugify helper |

## Related Specs
- `5.13-session-linking.md`
