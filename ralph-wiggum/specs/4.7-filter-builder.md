# Work Plan: 4.7 Filter Builder

## Context

### Original Request
Add UI controls to filter displayed tasks on the Kanban board by status.

### Interview Summary
**Key Discussions**:
- Backend already supports filtering via `fetchIssues({ status })` 
- Users need UI dropdown to select status: All, Backlog, In Progress, Done
- Filter state managed in page component, passed to KanbanBoard via props

**Research Findings**:
- `kanban-board.tsx:L80`: Currently uses `fetchIssues({ parentId: projectId })`
- `statuses.ts`: Exports `ISSUE_STATUSES` and `ALL_ISSUE_STATUSES` for dropdown options
- `query-keys.ts:L33`: Needs update to include filters in cache key
- Pattern reference: `CreateBoardDialog` uses shadcn Select component

### Spec Reference
- `ralph-wiggum/specs/4.7-filter-builder.md`

---

## Work Objectives

### Core Objective
Enable users to filter Kanban board tasks by status using a dropdown control.

### Concrete Deliverables
- `OpenKanban/src/features/boards/components/board-filter-controls.tsx` - New component
- Updated `OpenKanban/src/features/kanban/components/kanban-board.tsx` - Accept filters prop
- Updated `OpenKanban/src/lib/query-keys.ts` - Include filters in kanban key

### Definition of Done
- [ ] Filter dropdown appears above Kanban board
- [ ] Selecting "In Progress" shows only in-progress cards
- [ ] Selecting "All" shows all cards
- [ ] `pnpm run build` passes
- [ ] `pnpm run lint` passes

### Must Have
- Status dropdown using `ISSUE_STATUSES` constants (no hardcoded strings)
- Query invalidation when filter changes
- "All" option as default

### Must NOT Have (Guardrails)
- URL param persistence (future Task 17)
- Type filter (only status for now)
- Complex filter builder UI - keep it simple dropdown
- State in Zustand - use controlled props pattern

---

## Verification Strategy

### Test Decision
- **Infrastructure exists**: YES
- **User wants tests**: Manual verification for this task
- **QA approach**: Manual verification with playwright browser automation

---

## Task Flow

```
Task 1 (Query Keys) → Task 2 (Filter Component) → Task 3 (Integration)
```

## Parallelization

| Task | Depends On | Reason |
|------|------------|--------|
| 1 | None | Standalone update |
| 2 | 1 | Needs filter types defined |
| 3 | 2 | Needs component to integrate |

---

## TODOs

- [ ] 1. Update Query Keys to Include Filters

  **What to do**:
  - Open `OpenKanban/src/lib/query-keys.ts`
  - Update `kanban` key factory to accept optional `filters` parameter
  - Export `BoardFilters` type

  **Must NOT do**:
  - Don't change existing key structure for backward compatibility
  - Don't add type filter yet

  **Parallelizable**: NO (must complete first)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/lib/query-keys.ts:L33-34` - Current kanban key factory pattern

  **Type References**:
  - `OpenKanban/src/lib/constants/statuses.ts:L37` - `IssueStatus` type for filter values

  **Code to Add**:
  ```typescript
  // Add type export near top
  export interface BoardFilters {
    status?: string | null;
  }

  // Update kanban factory (line 33)
  kanban: (projectId?: string, boardId?: string, filters?: BoardFilters) =>
    ['kanban', projectId, boardId, filters].filter(x => x !== undefined) as const,
  ```

  **Acceptance Criteria**:
  - [ ] `BoardFilters` type exported from query-keys.ts
  - [ ] `kanban()` function accepts optional 3rd `filters` parameter
  - [ ] Build passes: `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(kanban): add filters support to query key factory`
  - Files: `src/lib/query-keys.ts`

---

- [ ] 2. Create BoardFilterControls Component

  **What to do**:
  - Create new file `OpenKanban/src/features/boards/components/board-filter-controls.tsx`
  - Create directory if needed: `OpenKanban/src/features/boards/components/`
  - Implement status dropdown using shadcn Select
  - Import and use `ISSUE_STATUSES` and `ALL_ISSUE_STATUSES` from constants
  - Add label mapping for display names

  **Must NOT do**:
  - Don't hardcode status strings
  - Don't add complex multi-filter UI
  - Don't manage state internally (controlled component)

  **Parallelizable**: NO (depends on 1)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/boards/components/create-board-dialog.tsx` - shadcn Select usage pattern (if exists)
  - `OpenKanban/src/components/ui/select.tsx` - shadcn Select component

  **Type References**:
  - `OpenKanban/src/lib/constants/statuses.ts:L21-25` - `ISSUE_STATUSES` constant
  - `OpenKanban/src/lib/constants/statuses.ts:L43` - `ALL_ISSUE_STATUSES` array
  - `OpenKanban/src/lib/query-keys.ts` - `BoardFilters` type (from Task 1)

  **Code Template**:
  ```typescript
  'use client';

  import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
  } from '@/components/ui/select';
  import { ISSUE_STATUSES, ALL_ISSUE_STATUSES, type IssueStatus } from '@/lib/constants/statuses';
  import type { BoardFilters } from '@/lib/query-keys';

  const STATUS_LABELS: Record<IssueStatus, string> = {
    [ISSUE_STATUSES.BACKLOG]: 'Backlog',
    [ISSUE_STATUSES.IN_PROGRESS]: 'In Progress',
    [ISSUE_STATUSES.DONE]: 'Done',
  };

  interface BoardFilterControlsProps {
    filters: BoardFilters;
    onFiltersChange: (filters: BoardFilters) => void;
  }

  export function BoardFilterControls({ filters, onFiltersChange }: BoardFilterControlsProps) {
    const handleStatusChange = (value: string) => {
      onFiltersChange({
        ...filters,
        status: value === 'all' ? null : value,
      });
    };

    return (
      <div className="flex items-center gap-4 px-4 py-2 border-b">
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">Status:</span>
          <Select
            value={filters.status ?? 'all'}
            onValueChange={handleStatusChange}
          >
            <SelectTrigger className="w-[140px] h-8">
              <SelectValue placeholder="All" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All</SelectItem>
              {ALL_ISSUE_STATUSES.map((status) => (
                <SelectItem key={status} value={status}>
                  {STATUS_LABELS[status]}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </div>
    );
  }
  ```

  **Acceptance Criteria**:
  - [ ] File exists: `OpenKanban/src/features/boards/components/board-filter-controls.tsx`
  - [ ] Component uses `ISSUE_STATUSES` constants (not hardcoded strings)
  - [ ] Dropdown has 4 options: All, Backlog, In Progress, Done
  - [ ] Build passes: `pnpm run build` → 0 errors

  **Commit**: YES
  - Message: `feat(boards): add BoardFilterControls component with status dropdown`
  - Files: `src/features/boards/components/board-filter-controls.tsx`

---

- [ ] 3. Integrate Filter Controls with KanbanBoard

  **What to do**:
  - Update `OpenKanban/src/features/kanban/components/kanban-board.tsx`:
    - Add `filters?: BoardFilters` to `KanbanBoardProps` interface
    - Update `fetchKanbanData` to pass `filters.status` to `fetchIssues()`
    - Update `useQuery` to include filters in query key
    - Render `BoardFilterControls` above the board
    - Add local state for filters in KanbanBoard (controlled pattern)
  - Update query invalidation to include filters

  **Must NOT do**:
  - Don't break existing drag-and-drop functionality
  - Don't add filter state to Zustand store
  - Don't modify the board page component (keep filter state in KanbanBoard)

  **Parallelizable**: NO (depends on 2)

  **References**:

  **Pattern References**:
  - `OpenKanban/src/features/kanban/components/kanban-board.tsx:L67-97` - `fetchKanbanData` function
  - `OpenKanban/src/features/kanban/components/kanban-board.tsx:L164-167` - `useQuery` usage
  - `OpenKanban/src/features/kanban/components/kanban-board.tsx:L183-186` - Query invalidation in mutation

  **API References**:
  - `OpenKanban/src/features/kanban/api.ts` - `fetchIssues()` function signature

  **Changes Required**:

  1. **Add imports** (top of file):
  ```typescript
  import { BoardFilterControls } from '@/features/boards/components/board-filter-controls';
  import type { BoardFilters } from '@/lib/query-keys';
  ```

  2. **Update props interface** (~line 39):
  ```typescript
  interface KanbanBoardProps {
    projectId?: string;
    boardId?: string;
  }
  // No change needed - filters managed internally
  ```

  3. **Add state** (after line 146):
  ```typescript
  const [filters, setFilters] = useState<BoardFilters>({});
  ```

  4. **Update fetchKanbanData signature** (line 67):
  ```typescript
  async function fetchKanbanData(
    projectId?: string,
    boardId?: string,
    filters?: BoardFilters
  ): Promise<{ boardId: string; columns: Column[]; tasks: Task[] }> {
  ```

  5. **Update fetchIssues call** (line 80):
  ```typescript
  const issues = await fetchIssues({ 
    parentId: projectId,
    status: filters?.status ?? undefined 
  });
  ```

  6. **Update useQuery** (line 164):
  ```typescript
  const { data, isLoading, error } = useQuery({
    queryKey: queryKeys.kanban(projectId, boardId, filters),
    queryFn: () => fetchKanbanData(projectId, boardId, filters),
  });
  ```

  7. **Update invalidation** (line 184):
  ```typescript
  void queryClient.invalidateQueries({ queryKey: queryKeys.kanban(projectId, boardId, filters) });
  ```

  8. **Render filter controls** (before DndContext, ~line 458):
  ```typescript
  return (
    <ColumnMutationsProvider projectId={projectId} boardId={boardId}>
      <BoardFilterControls filters={filters} onFiltersChange={setFilters} />
      <DndContext ...>
  ```

  **Acceptance Criteria**:

  **Manual Verification** (using Playwright browser):
  - [ ] Navigate to: `http://localhost:37291/project/[projectId]/board/[boardId]`
  - [ ] Verify: Filter dropdown visible above board
  - [ ] Action: Select "In Progress" from dropdown
  - [ ] Verify: Only in-progress cards visible (Backlog/Done columns empty or hidden)
  - [ ] Action: Select "All" from dropdown
  - [ ] Verify: All cards return to their columns
  - [ ] Verify: Page refresh resets filter to "All"

  **Build Verification**:
  - [ ] `pnpm run build` → 0 errors
  - [ ] `pnpm run lint` → 0 errors

  **Commit**: YES
  - Message: `feat(kanban): integrate status filter controls with board`
  - Files: `src/features/kanban/components/kanban-board.tsx`

---

## Commit Strategy

| After Task | Message | Files | Verification |
|------------|---------|-------|--------------|
| 1 | `feat(kanban): add filters support to query key factory` | query-keys.ts | pnpm build |
| 2 | `feat(boards): add BoardFilterControls component` | board-filter-controls.tsx | pnpm build |
| 3 | `feat(kanban): integrate status filter controls` | kanban-board.tsx | pnpm build && manual test |

---

## Success Criteria

### Verification Commands
```bash
pnpm run build  # Expected: 0 errors
pnpm run lint   # Expected: 0 errors
```

### Final Checklist
- [ ] Filter dropdown visible above Kanban board
- [ ] Status filtering works correctly
- [ ] "All" shows all tasks
- [ ] Query invalidates on filter change
- [ ] No hardcoded status strings
- [ ] Build and lint pass
