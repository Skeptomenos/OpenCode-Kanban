# Spec: Phase 4.7 - Filter Builder

> **Goal**: Add UI controls to filter displayed tasks on the Kanban board by status.
> **Context**: Backend already supports filtering via `fetchIssues({ status?, type?, parentId? })`. Users need UI to narrow down visible cards.
> **Roadmap Reference**: `docs/ROADMAP.md:L102`

## 1. Problem Statement

The Kanban board currently displays ALL issues for a project. Users need to:
- Focus on specific statuses (e.g., "only show In Progress")
- Hide completed items when planning
- Quickly filter to "Done" to review completed work

## 2. Requirements

### 2.1 Filter Controls Component

- **File**: `OpenKanban/src/features/boards/components/board-filter-controls.tsx`
- **Props**: 
    ```typescript
    interface BoardFilterControlsProps {
      projectId: string;
      filters: BoardFilters;
      onFiltersChange: (filters: BoardFilters) => void;
    }
    
    interface BoardFilters {
      status?: string | null;
    }
    ```
- **Behavior**:
    - Render a horizontal toolbar above the Kanban board
    - Show a "Status" dropdown with options from `ISSUE_STATUSES`:
        - "All" (default, clears filter)
        - "Backlog"
        - "In Progress"
        - "Done"
    - On selection change, call `onFiltersChange` with updated filters

### 2.2 Integration with KanbanBoard

- **File**: `OpenKanban/src/features/kanban/components/kanban-board.tsx`
- **Update**:
    - Accept optional `filters?: BoardFilters` prop
    - Pass `filters.status` to `fetchIssues()` call in `fetchKanbanData()`
    - Render `BoardFilterControls` above the board

### 2.3 State Management

- **Approach**: Controlled state in parent component (board page)
- **File**: `OpenKanban/src/app/project/[projectId]/board/[boardId]/page.tsx`
- **Logic**:
    - Store `filters` in component state: `const [filters, setFilters] = useState<BoardFilters>({})`
    - Pass to `KanbanBoard` component
    - **Future (Task 17)**: Optionally persist to URL params for shareable links

## 3. UI Design

```
+----------------------------------------------------------------------+
| [Status: All v]                                                       |
+----------------------------------------------------------------------+
| Backlog          | In Progress      | Done             | + Add Section |
| +-------------+  | +-------------+  | +-------------+  |              |
| | Card 1      |  | | Card 2      |  | | Card 3      |  |              |
| +-------------+  | +-------------+  | +-------------+  |              |
+----------------------------------------------------------------------+
```

### 2.3.1 Component Styling

- Use shadcn `Select` component for dropdown
- Match existing UI patterns (see `CreateBoardDialog`)
- Compact style: ~32px height toolbar
- Left-aligned controls
- Subtle border-bottom separating filter bar from board

### 2.3.2 Responsive Behavior

- Desktop: Horizontal layout, all filters visible
- Mobile: Collapsible or stacked layout (future enhancement)

## 4. API Layer Updates

### 4.1 Update fetchKanbanData

- **File**: `OpenKanban/src/features/kanban/components/kanban-board.tsx`
- **Current**: 
    ```typescript
    const issues = await fetchIssues({ parentId: projectId });
    ```
- **Updated**:
    ```typescript
    const issues = await fetchIssues({ 
      parentId: projectId,
      status: filters?.status ?? undefined
    });
    ```

### 4.2 Update Query Key

- **File**: `OpenKanban/src/lib/query-keys.ts`
- **Update**: `kanban` key factory to include filters:
    ```typescript
    kanban: (projectId?: string, boardId?: string, filters?: { status?: string }) => 
      ['kanban', projectId, boardId, filters].filter(Boolean)
    ```

## 5. Status Constants Integration

- **File**: `OpenKanban/src/lib/constants/statuses.ts`
- **Usage**: Import `ISSUE_STATUSES` and `ALL_ISSUE_STATUSES` for dropdown options
- **Label Mapping**:
    ```typescript
    const STATUS_LABELS: Record<IssueStatus, string> = {
      [ISSUE_STATUSES.BACKLOG]: 'Backlog',
      [ISSUE_STATUSES.IN_PROGRESS]: 'In Progress',
      [ISSUE_STATUSES.DONE]: 'Done',
    };
    ```

## 6. Definition of Done

- [ ] `BoardFilterControls` component created with status dropdown
- [ ] Dropdown uses `ISSUE_STATUSES` constants (no hardcoded strings)
- [ ] `KanbanBoard` accepts and applies `filters` prop
- [ ] Filtering works: selecting "In Progress" hides Backlog/Done cards
- [ ] "All" selection clears filter and shows all cards
- [ ] Query invalidates correctly when filter changes
- [ ] `pnpm run build` passes
- [ ] `pnpm run lint` passes

## 7. Implementation Plan

1. **Task 14**: Create `board-filter-controls.tsx` skeleton with status dropdown
2. **Task 15**: Implement status filter dropdown using `ISSUE_STATUSES`
3. **Task 16**: Wire filter controls to `KanbanBoard` via props and update `fetchKanbanData`
4. **Task 17**: (Optional) Add filter persistence to URL params

## 8. Estimated Effort

3-4 hours total

## 9. Test Scenarios

### Manual Verification:
1. Navigate to project with tasks in multiple statuses
2. Verify "All" shows all tasks
3. Select "In Progress" - verify only in-progress cards visible
4. Select "Done" - verify only done cards visible
5. Select "All" again - verify all cards return
6. Refresh page - verify filter resets to "All" (or persists if Task 17 done)

### Automated Tests (Future):
- Unit test: `BoardFilterControls` renders dropdown with correct options
- Unit test: `onFiltersChange` called with correct value on selection
- Integration test: `KanbanBoard` passes filters to API
